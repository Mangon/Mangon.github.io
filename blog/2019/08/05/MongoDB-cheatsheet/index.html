<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    

    
    <title>
        MongoDB 小抄 | 
        Gblog
    </title>
    <meta name="author" content="Mangon" />
    <meta name="version" content="1.1.0" />
    
    <meta name="keywords" content="Mangon blog, 技术博客, 前端学习, 前端基础" />
    
    
    <meta name="description" content="MongoDBMongoDB 是一个基于分布式文件存储的数据库，截止当前日期（2019-08-05） 最新版本是 MongoDB 4.0。MongoDB由 C++ 语言编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。MongoDB 将数据存储为一个文档，数据结构由键值对(key=&amp;gt;value)组成。 MongoDB 文档类型似于 JSON 对象。字段值可以包含其他文档，数组及文档数组等。你可以在 MongoDB 官网 下载安装包。MongoDB可视化工具有 Robomongo" />
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
    
    <meta name="baidu-site-verification" content="pWri9ahJmw" />
    
    
    
    <link rel="icon" href="/blog/images/favicon.ico">
    
    
<link rel="stylesheet" href="/blog/css/style.css">

    <link rel="stylesheet" href="/blog/css/jquery.modal.min.css"></link>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/blog/atom.xml" title="Gblog" type="application/atom+xml">
</head>
<body>

    <main class="app">
        <header class="header clearfix">
    <div id="nav" class="nav">
    <button id="open-panel" class="open-panel"><i class="icon-library"></i></button>
    <nav class="nav-inner">
        
            
                <li class="nav-item ">
                    <a class="nav-link" href="/blog/">主页</a>
                </li>
            
        
            
                <li class="nav-item ">
                    <a class="nav-link" href="/blog/archives">目录</a>
                </li>
            
        
    </nav>
</div>

    <aside id="aside" class="aside">
    <div id="aside-mask" class="aside-mask"></div>
    <div id="aside-inner" class="aside-inner">
        <div class="search-box" id="search-box">
    <form>
        <div class="search-btn"></div>
        <input autocomplete="off" type="text" id="search-input" name="q" results="0" placeholder="搜索"
        />
        <button type="reset" class="reset-search-btn"></button>
    </form>
</div>        
        
            
        

        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB"><span class="toc-text">MongoDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB-%E5%91%BD%E4%BB%A4"><span class="toc-text">MongoDB 命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB-%E6%A6%82%E5%BF%B5%E8%A7%A3%E6%9E%90"><span class="toc-text">MongoDB 概念解析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Database"><span class="toc-text">Database</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Collection"><span class="toc-text">Collection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Document"><span class="toc-text">Document</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BSON-Types"><span class="toc-text">BSON Types</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#ObjectId"><span class="toc-text">ObjectId</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#String"><span class="toc-text">String</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Timestamp"><span class="toc-text">Timestamp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Date"><span class="toc-text">Date</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB-%E8%BF%9E%E6%8E%A5"><span class="toc-text">MongoDB 连接</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MongoDB-shell-%E6%96%B9%E6%B3%95"><span class="toc-text">MongoDB shell 方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93-Database-%E7%9B%B8%E5%85%B3"><span class="toc-text">数据库(Database)相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">创建数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%80%E6%9C%89%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">查看所有数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93%E5%90%8D"><span class="toc-text">查看当前数据库名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-text">删除当前数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E6%95%B0%E6%8D%AE%E5%BA%93%E7%8A%B6%E6%80%81"><span class="toc-text">查看当前数据库状态</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E5%90%88-Collection-%E7%9B%B8%E5%85%B3"><span class="toc-text">集合(Collection)相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%9B%86%E5%90%88-%E8%A7%86%E5%9B%BE"><span class="toc-text">创建集合&#x2F;视图</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8DDatabase%E4%B8%8B%E6%89%80%E6%9C%89%E9%9B%86%E5%90%88"><span class="toc-text">查看当前Database下所有集合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E9%9B%86%E5%90%88"><span class="toc-text">删除集合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E6%A1%A3-Document-%E7%9B%B8%E5%85%B3"><span class="toc-text">文档(Document)相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8F%92%E5%85%A5%E6%96%87%E6%A1%A3"><span class="toc-text">插入文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E6%96%87%E6%A1%A3"><span class="toc-text">更新文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E6%96%87%E6%A1%A3"><span class="toc-text">删除文档</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E6%96%87%E6%A1%A3"><span class="toc-text">查询文档</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95-Index-%E7%9B%B8%E5%85%B3"><span class="toc-text">索引(Index)相关</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%B4%A2%E5%BC%95"><span class="toc-text">创建索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%B4%A2%E5%BC%95"><span class="toc-text">删除索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95"><span class="toc-text">查看索引</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AE%9A%E7%B4%A2%E5%BC%95"><span class="toc-text">强制使用指定索引</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E5%B8%B8%E7%94%A8"><span class="toc-text">其它常用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%9A%E5%90%88"><span class="toc-text">聚合</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-text">格式化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F"><span class="toc-text">排序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%90%E5%88%B6%E8%BF%94%E5%9B%9E%E6%9D%A1%E6%95%B0"><span class="toc-text">限制返回条数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%B3%E8%BF%87%E5%9B%BA%E5%AE%9A%E6%9D%A1%E6%95%B0%E6%95%B0%E6%8D%AE"><span class="toc-text">跳过固定条数数据</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-text">查看执行计划</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MongoDB-%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="toc-text">MongoDB 操作符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8B%E5%8A%A1%E4%B8%8E%E5%8E%9F%E5%AD%90%E6%80%A7"><span class="toc-text">事务与原子性</span></a></li></ol>
        
        <div id="coffee-content"></div>
    </div>
</aside>

</header>

        
            <div data-spy="scroll" data-target="#aside-inner" id="content" class="content">
        
            <article class="article" itemscope itemprop="blogPost">
    
    <header class="article-header">
        
        <h1 itemprop="name">
            MongoDB 小抄
        </h1>
        
        <div class="article-meta clearfix">
            <span class="article-date">
    
    <i class="icon-calendar"></i>
    
    <time datetime="2019-08-05T06:04:31.000Z" itemprop="datePublished">2019-08-05</time>
</span>

            
<div class="article-tag-list">
    <i class="icon-tag"></i>
    <a class="article-tag-link" href="/blog/tags/MongoDB/" rel="tag">MongoDB</a>, <a class="article-tag-link" href="/blog/tags/database/" rel="tag">database</a>
</div>


        </div>
    </header>
    
    <section class="article-body markdown-body">
        
            <h2 id="MongoDB"><a href="#MongoDB" class="headerlink" title="MongoDB"></a>MongoDB</h2><p><a target="_blank" rel="noopener" href="https://www.mongodb.com/">MongoDB</a> 是一个基于分布式文件存储的数据库，截止当前日期（2019-08-05） 最新版本是 MongoDB 4.0。MongoDB由 C++ 语言编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案。<br>MongoDB 将数据存储为一个文档，数据结构由键值对(key=&gt;value)组成。 MongoDB 文档类型似于 JSON 对象。字段值可以包含其他文档，数组及文档数组等。<br>你可以在 MongoDB 官网 <a target="_blank" rel="noopener" href="https://www.mongodb.com/download-center/community">下载安装包</a>。<br>MongoDB可视化工具有 <a target="_blank" rel="noopener" href="https://robomongo.org/">Robomongo</a> 等。<br>MongoDB的文档写的很好可惜没有中文版的，英语不错的同学可以直接访问 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/">MongoDB文档官网</a>  </p>
<!-- more -->
<h2 id="MongoDB-命令"><a href="#MongoDB-命令" class="headerlink" title="MongoDB 命令"></a>MongoDB 命令</h2><p>Windows系统下的命令如下，其他系统类似：</p>
<ol>
<li>运行Mongo服务器</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">mongodb</span>\<span class="title">bin</span>\<span class="title">mongod</span> --<span class="title">dbpath</span> <span class="title">c</span>:\<span class="title">data</span>\<span class="title">db</span></span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>启动命令行界面连接MongoDB(打开MongoDB Shell)</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">mongodb</span>\<span class="title">bin</span>\<span class="title">mongo.exe</span> --<span class="title">port</span> 28015</span></span><br></pre></td></tr></table></figure>
<p>默认连接27017端口，可以通过 <code>--port</code> 指定端口<br>可以通过 <code>--host &lt;host&gt;:&lt;port&gt;</code> 指定连接远程实例  </p>
<ol start="3">
<li>安装MongoDB服务</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">mongodb</span>\<span class="title">bin</span>\<span class="title">mongod.exe</span> --<span class="title">config</span> &quot;<span class="title">C</span>:\<span class="title">mongodb</span>\<span class="title">mongod.cfg</span>&quot; --<span class="title">install</span></span></span><br></pre></td></tr></table></figure>
<ol start="4">
<li>启用MongoDB服务</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> <span class="built_in">start</span> MongoDB</span><br></pre></td></tr></table></figure>
<ol start="5">
<li>关闭MongoDB服务</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">net</span> stop MongoDB</span><br></pre></td></tr></table></figure>
<ol start="6">
<li>移除MongoDB服务</li>
</ol>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">mongodb</span>\<span class="title">bin</span>\<span class="title">mongod.exe</span> --<span class="title">remove</span></span></span><br></pre></td></tr></table></figure>
<h2 id="MongoDB-概念解析"><a href="#MongoDB-概念解析" class="headerlink" title="MongoDB 概念解析"></a>MongoDB 概念解析</h2><table>
<thead>
<tr>
<th>SQL概念</th>
<th>MongoDB概念</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>database</td>
<td>数据库</td>
</tr>
<tr>
<td>table</td>
<td>collection</td>
<td>表/集合</td>
</tr>
<tr>
<td>row</td>
<td>document</td>
<td>行/文档</td>
</tr>
<tr>
<td>column</td>
<td>field</td>
<td>列or字段/域</td>
</tr>
<tr>
<td>index</td>
<td>index</td>
<td>索引</td>
</tr>
<tr>
<td>primary key</td>
<td>primary key</td>
<td>主键，MongoDB自动将 _id 域设置为主键</td>
</tr>
</tbody>
</table>
<h3 id="Database"><a href="#Database" class="headerlink" title="Database"></a>Database</h3><p>一个mongodb中可以创建多个数据库。<br>MongoDB的默认数据库为”db”，该数据库存储在data目录中。<br>MongoDB的单个实例可以容纳多个独立的数据库，每一个都有自己的集合和权限，不同的数据库也放置在不同的文件中。<br>数据库名可以是满足以下条件的任意UTF-8字符串。  </p>
<ul>
<li>不能是空字符串（””)。</li>
<li>不得含有’ ‘（空格)、.、$、/、\和\0 (空字符)。</li>
<li>应全部小写。</li>
<li>最多64字节。</li>
</ul>
<p>有一些数据库名是保留的，可以直接访问这些有特殊作用的数据库。  </p>
<table>
<thead>
<tr>
<th>数据库名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>admin</td>
<td>从权限的角度来看，这是”root”数据库。要是将一个用户添加到这个数据库，这个用户自动继承所有数据库的权限。一些特定的服务器端命令也只能从这个数据库运行，比如列出所有的数据库或者关闭服务器。</td>
</tr>
<tr>
<td>local</td>
<td>这个数据永远不会被复制，可以用来存储限于本地单台服务器的任意集合</td>
</tr>
<tr>
<td>config</td>
<td>当Mongo用于分片设置时，config数据库在内部使用，用于保存分片的相关信息。</td>
</tr>
</tbody>
</table>
<h3 id="Collection"><a href="#Collection" class="headerlink" title="Collection"></a>Collection</h3><p>集合就是 MongoDB 文档组。<br>集合存在于数据库中，集合没有固定的结构，这意味着你在对集合可以插入不同格式和类型的数据，但通常情况下我们插入集合的数据都会有一定的关联性。  </p>
<p>合法的集合名需要满足以下条件。  </p>
<ul>
<li>集合名不能是空字符串””。</li>
<li>集合名不能含有\0字符（空字符)，这个字符表示集合名的结尾。</li>
<li>集合名不能以”system.”开头，这是为系统集合保留的前缀。</li>
<li>用户创建的集合名字不能含有保留字符。有些驱动程序的确支持在集合名里面包含，这是因为某些系统生成的集合中包含该字符。除非你要访问这种系统创建的集合，否则千万不要在名字里出现$。</li>
</ul>
<h3 id="Document"><a href="#Document" class="headerlink" title="Document"></a>Document</h3><p>文档是一组键值(key-value)对(即 BSON )。MongoDB 的文档不需要设置相同的字段，并且相同的字段不需要相同的数据类型，这与关系型数据库有很大的区别，也是 MongoDB 非常突出的特点。  </p>
<p>需要注意的是：</p>
<ul>
<li>文档中的键/值对是有序的。</li>
<li>文档中的值不仅可以是在双引号里面的字符串，还可以是其他几种数据类型（甚至可以是整个嵌入的文档)。</li>
<li>MongoDB区分类型和大小写。</li>
<li>MongoDB的文档不能有重复的键。</li>
<li>文档的键是字符串。除了少数例外情况，键可以使用任意UTF-8字符。</li>
</ul>
<p>文档键命名规范：</p>
<ul>
<li>键不能含有\0 (空字符)。这个字符用来表示键的结尾。<br>.和$有特别的意义，只有在特定环境下才能使用。</li>
<li>以下划线”_”开头的键是保留的(不是严格要求的)。</li>
</ul>
<h3 id="BSON-Types"><a href="#BSON-Types" class="headerlink" title="BSON Types"></a>BSON Types</h3><p>BSON是一种在MongoDB中使用的用来存储文档和进行远程存储过程调用二进制序序列化格式。</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>数字</th>
<th>别名</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>Double</td>
<td>1</td>
<td>“double”</td>
<td>双精度浮点值。用于存储浮点值。</td>
</tr>
<tr>
<td>String</td>
<td>2</td>
<td>“string”</td>
<td>字符串。存储数据常用的数据类型。在 MongoDB 中，UTF-8 编码的字符串才是合法的。</td>
</tr>
<tr>
<td>Object</td>
<td>3</td>
<td>“object”</td>
<td>用于内嵌文档。</td>
</tr>
<tr>
<td>Array</td>
<td>4</td>
<td>“array”</td>
<td>用于将数组或列表或多个值存储为一个键。</td>
</tr>
<tr>
<td>Binary data</td>
<td>5</td>
<td>“binData”</td>
<td>二进制数据。用于存储二进制数据。</td>
</tr>
<tr>
<td>Undefined</td>
<td>6</td>
<td>“undefined”</td>
<td>废除</td>
</tr>
<tr>
<td>ObjectId</td>
<td>7</td>
<td>“objectId”</td>
<td>对象 ID。用于创建文档的 ID。</td>
</tr>
<tr>
<td>Boolean</td>
<td>8</td>
<td>“bool”</td>
<td>布尔值。用于存储布尔值（真/假）。</td>
</tr>
<tr>
<td>Date</td>
<td>9</td>
<td>“date”</td>
<td>日期时间。用 UNIX 时间格式来存储当前日期或时间。你可以指定自己的日期时间：创建 Date 对象，传入年月日信息</td>
</tr>
<tr>
<td>Null</td>
<td>10</td>
<td>“null”</td>
<td>用于创建空值。</td>
</tr>
<tr>
<td>Regular Expression</td>
<td>11</td>
<td>“regex”</td>
<td>正则表达式类型。用于存储正则表达式。</td>
</tr>
<tr>
<td>DBPointer</td>
<td>12</td>
<td>“dbPointer”</td>
<td>废除</td>
</tr>
<tr>
<td>JavaScript</td>
<td>13</td>
<td>“javascript”</td>
<td>代码类型。用于在文档中存储 JavaScript 代码。</td>
</tr>
<tr>
<td>Symbol</td>
<td>14</td>
<td>“symbol”</td>
<td>废除</td>
</tr>
<tr>
<td>JavaScript (with scope)</td>
<td>15</td>
<td>“javascriptWithScope”</td>
<td>-</td>
</tr>
<tr>
<td>32-bit integer</td>
<td>16</td>
<td>“int”</td>
<td>23位整型数值。用于存储数值</td>
</tr>
<tr>
<td>Timestamp</td>
<td>17</td>
<td>“timestamp”</td>
<td>时间戳。记录文档修改或添加的具体时间。</td>
</tr>
<tr>
<td>64-bit integer</td>
<td>18</td>
<td>“long”</td>
<td>64位整型数值。用于存储数值</td>
</tr>
<tr>
<td>Decimal128</td>
<td>19</td>
<td>“decimal”</td>
<td>3.4版本新加</td>
</tr>
<tr>
<td>Min key</td>
<td>-1</td>
<td>“minKey”</td>
<td>-</td>
</tr>
<tr>
<td>Max key</td>
<td>127</td>
<td>“maxKey”</td>
<td>-</td>
</tr>
</tbody>
</table>
<h4 id="ObjectId"><a href="#ObjectId" class="headerlink" title="ObjectId"></a>ObjectId</h4><p>ObjectId 类似唯一主键，可以很快的去生成和排序，包含 12 bytes:</p>
<ul>
<li>前 4 个字节表示文档创建时间 unix 时间戳</li>
<li>中间 5 个字节是随机数</li>
<li>最后 3 个字节是以随机数开始的计数器</li>
</ul>
<p>MongoDB 中存储的文档必须有一个 _id 键。这个键的值可以是任何类型的，默认是个 ObjectId 对象</p>
<p>由于 ObjectId 中保存了创建的时间戳，所以你可以通过 <code>ObjectId().getTimestamp()</code> 函数来获取创建时间:  </p>
<h4 id="String"><a href="#String" class="headerlink" title="String"></a>String</h4><p>BSON 字符串只能是 UTF-8 编码。<br>内部 sort() 方法使用了 C++ 的 strcmp API，所以部分排序可能并不正确。  </p>
<h4 id="Timestamp"><a href="#Timestamp" class="headerlink" title="Timestamp"></a>Timestamp</h4><p>Timestamp是用在MongoDB内部的时间戳类型。  </p>
<ul>
<li>前 32 位是一个 time_t 值（与Unix新纪元相差的秒数）</li>
<li>后 32 位是在某秒中操作的一个递增的序数</li>
</ul>
<h4 id="Date"><a href="#Date" class="headerlink" title="Date"></a>Date</h4><p>BSON Date 是一个64位整型，表示当前距离 Unix新纪元（1970年1月1日）的毫秒数。日期类型是有符号的, 负数表示 1970 年之前的日期。  </p>
<h2 id="MongoDB-连接"><a href="#MongoDB-连接" class="headerlink" title="MongoDB 连接"></a>MongoDB 连接</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodb://[username:password@]host1[:port1][,...hostN[:portN]][/[database][?options]]</span><br></pre></td></tr></table></figure>
<ul>
<li><p><strong>mongodb://</strong> mongodb协议头。</p>
</li>
<li><p><strong>username:password@</strong> 可选项，如果设置，在连接数据库服务器之后，驱动都会尝试登录这个数据库。</p>
</li>
<li><p><strong>hostX</strong> 必须的指定至少一个host, host1 是这个URI唯一要填写的。它指定了要连接服务器的地址。如果要连接复数集，请指定多个主机地址。</p>
</li>
<li><p><strong>portX</strong> 可选的指定端口，如果不填，默认为27017。</p>
</li>
<li><p><strong>/database</strong> 如果指定username:password@，连接并验证登录指定数据库。若不指定，默认打开 test 数据库。</p>
</li>
<li><p><strong>?options</strong> 是连接选项。如果不使用/database，则前面需要加上/。所有连接选项都是键值对name=value，键值对之间通过&amp;或;（分号）隔开。</p>
</li>
</ul>
<h2 id="MongoDB-shell-方法"><a href="#MongoDB-shell-方法" class="headerlink" title="MongoDB shell 方法"></a>MongoDB shell 方法</h2><p>参见<a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/reference/method/index.html">mongo Shell Methods</a>，以下列举一些常用的方法：  </p>
<h3 id="数据库-Database-相关"><a href="#数据库-Database-相关" class="headerlink" title="数据库(Database)相关"></a>数据库(Database)相关</h3><h4 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use DATABASE_NAME</span><br></pre></td></tr></table></figure>
<h4 id="查看所有数据库"><a href="#查看所有数据库" class="headerlink" title="查看所有数据库"></a>查看所有数据库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show dbs</span><br></pre></td></tr></table></figure>
<h4 id="查看当前数据库名"><a href="#查看当前数据库名" class="headerlink" title="查看当前数据库名"></a>查看当前数据库名</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db</span><br></pre></td></tr></table></figure>
<h4 id="删除当前数据库"><a href="#删除当前数据库" class="headerlink" title="删除当前数据库"></a>删除当前数据库</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>
<h4 id="查看当前数据库状态"><a href="#查看当前数据库状态" class="headerlink" title="查看当前数据库状态"></a>查看当前数据库状态</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.stats()</span><br></pre></td></tr></table></figure>
<h3 id="集合-Collection-相关"><a href="#集合-Collection-相关" class="headerlink" title="集合(Collection)相关"></a>集合(Collection)相关</h3><h4 id="创建集合-视图"><a href="#创建集合-视图" class="headerlink" title="创建集合/视图"></a>创建集合/视图</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.createCollection(&lt;name&gt;, &lt;options&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>name</strong>: 要创建的集合名称</li>
<li><strong>options</strong>: 可选参数，指定有关内存大小及索引的选项</li>
</ul>
<p>options 可以是如下参数：  </p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>capped</td>
<td>布尔</td>
<td>（可选）如果为 true，则创建固定集合。固定集合是指有着固定大小的集合，当达到最大值时，它会自动覆盖最早的文档。<strong>当该值为 true 时，必须指定 size 参数。</strong></td>
</tr>
<tr>
<td>autoIndexId</td>
<td>布尔</td>
<td>（可选）如为 true，自动在 _id 字段创建索引。默认为 false。</td>
</tr>
<tr>
<td>size</td>
<td>数值</td>
<td>（可选）为固定集合指定一个最大值（以字节计）。<strong>如果 capped 为 true，也需要指定该字段。</strong></td>
</tr>
<tr>
<td>max</td>
<td>数值</td>
<td>（可选）指定固定集合中包含文档的最大数量。</td>
</tr>
</tbody>
</table>
<h4 id="查看当前Database下所有集合"><a href="#查看当前Database下所有集合" class="headerlink" title="查看当前Database下所有集合"></a>查看当前Database下所有集合</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show collections</span><br><span class="line">show tables</span><br></pre></td></tr></table></figure>
<h4 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.drop()</span><br></pre></td></tr></table></figure>
<h3 id="文档-Document-相关"><a href="#文档-Document-相关" class="headerlink" title="文档(Document)相关"></a>文档(Document)相关</h3><h4 id="插入文档"><a href="#插入文档" class="headerlink" title="插入文档"></a>插入文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.insert(&lt;document&gt;)</span><br><span class="line">db.COLLECTION_NAME.insertOne(&lt;document&gt;)</span><br><span class="line">db.COLLECTION_NAME.insertMany(&lt;document&gt;)</span><br></pre></td></tr></table></figure>
<p>如果 COLLECTION_NAME 该集合不在该数据库中， MongoDB 会自动创建该集合并插入文档.  </p>
<ul>
<li><strong>document</strong>: 待插入的文档</li>
</ul>
<h4 id="更新文档"><a href="#更新文档" class="headerlink" title="更新文档"></a>更新文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.update(</span><br><span class="line">   &lt;filter&gt;,</span><br><span class="line">   &lt;update&gt;,</span><br><span class="line">   &lt;options&gt;</span><br><span class="line">)</span><br><span class="line">db.COLLECTION_NAME.updateOne(...)</span><br><span class="line">db.COLLECTION_NAME.updateMany(...)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>filter</strong> : update的查询条件。</li>
<li><strong>update</strong> : update的对象和一些更新的操作符（如$,$inc…）等。</li>
<li><strong>options</strong> : 可选参数，指定更新文档的选项</li>
</ul>
<p>options可以是如下参数：  </p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>upsert</td>
<td>boolean</td>
<td>可选，这个参数的意思是，如果不存在update的记录，是否插入objNew，true为插入，默认是false，不插入</td>
</tr>
<tr>
<td>multi</td>
<td>boolean</td>
<td>可选，mongodb 默认是false，只更新找到的第一条记录，如果这个参数为true，就把按条件查出来多条记录全部更新</td>
</tr>
<tr>
<td>writeConcern</td>
<td>document</td>
<td>可选，写级别</td>
</tr>
<tr>
<td>collation</td>
<td>document</td>
<td>可选，数据的校验</td>
</tr>
<tr>
<td>arrayFilters</td>
<td>[&lt;filterdocument1\>,…]</td>
<td>可选，文档过滤器的数组</td>
</tr>
</tbody>
</table>
<h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.remove(&lt;query&gt;, &lt;options&gt;)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>query</strong> : 删除的查询条件。</li>
</ul>
<p>options可以是如下参数：  </p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>justOne</td>
<td>boolean</td>
<td>可选，true的话只删除第一个找到的文档。默认 false，删除所有符合query的文档</td>
</tr>
<tr>
<td>writeConcern</td>
<td>document</td>
<td>可选，写级别</td>
</tr>
<tr>
<td>collation</td>
<td>document</td>
<td>可选，数据的校验</td>
</tr>
</tbody>
</table>
<h4 id="查询文档"><a href="#查询文档" class="headerlink" title="查询文档"></a>查询文档</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find(&lt;query&gt;, &lt;projection&gt;)</span><br><span class="line">db.COLLECTION_NAME.findOne(...)</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>query</strong> : 查询的条件。</li>
<li><strong>projection</strong> : 可选，表明文档中需要返回的符合query过滤器的域，忽略此参数时返回所有的域</li>
</ul>
<h3 id="索引-Index-相关"><a href="#索引-Index-相关" class="headerlink" title="索引(Index)相关"></a>索引(Index)相关</h3><p>MongoDB 索引使用 B-tree 数据结构。MongoDB 会在集合创建时建立唯一索引 <code>_id</code> 且不能删除。MongoDB可以创建复合索引。</p>
<h4 id="创建索引"><a href="#创建索引" class="headerlink" title="创建索引"></a>创建索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.createIndex( &lt;keys&gt;, &lt;options&gt; )</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>keys</strong> 健值对文档，指定索引的字段和排序方式</li>
<li><strong>options</strong> 可选参数，指定有关索引的其它选项</li>
</ul>
<p>options可以是如下参数：  </p>
<table>
<thead>
<tr>
<th>字段</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>background</td>
<td>boolean</td>
<td>可选，指定是否在后台创建索引，默认false</td>
</tr>
<tr>
<td>unique</td>
<td>boolean</td>
<td>可选，指定是否是唯一索引，默认false</td>
</tr>
<tr>
<td>name</td>
<td>string</td>
<td>可选，指定索引名。不提供的话，MongoDB会将索引名和排序方式连接来生成索引名</td>
</tr>
<tr>
<td>partialFilterExpression</td>
<td>document</td>
<td>可选，若提供则仅对符合过滤表达式的文档建立索引</td>
</tr>
<tr>
<td>sparse</td>
<td>boolean</td>
<td>可选，若提供则仅针对提供的field进行索引，这样的话索引占用空间会更小，但对非指定的field进行排序会有影响，默认false</td>
</tr>
<tr>
<td>expireAfterSeconds</td>
<td>integer</td>
<td>可选，提供一个秒为单位的数字来控制索引的存在时间</td>
</tr>
<tr>
<td>storageEngine</td>
<td>document</td>
<td>可选</td>
</tr>
<tr>
<td>collation</td>
<td>document</td>
<td>可选，表明索引的排序规则</td>
</tr>
</tbody>
</table>
<h4 id="删除索引"><a href="#删除索引" class="headerlink" title="删除索引"></a>删除索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.dropIndex(&lt;index name&gt;)</span><br><span class="line">db.COLLECTION_NAME.dropIndexes() // 删除所有索引</span><br></pre></td></tr></table></figure>
<h4 id="查看索引"><a href="#查看索引" class="headerlink" title="查看索引"></a>查看索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.getIndexes()</span><br></pre></td></tr></table></figure>
<h4 id="强制使用指定索引"><a href="#强制使用指定索引" class="headerlink" title="强制使用指定索引"></a>强制使用指定索引</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find(&lt;query&gt;).hint(&lt;string or document&gt;)</span><br><span class="line">db.COLLECTION_NAME.find( &#123; $query: &#123;&#125;, $hint: &lt;string or document&gt; &#125; )</span><br></pre></td></tr></table></figure>
<h3 id="其它常用"><a href="#其它常用" class="headerlink" title="其它常用"></a>其它常用</h3><h4 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.aggregate(pipeline, options)</span><br></pre></td></tr></table></figure>
<p>用于通过管道计算集合/视图数据的聚合结果。  </p>
<ul>
<li><strong>pipeline</strong> 可以取 聚合管道步骤 的操作符</li>
<li><strong>options</strong> 可选参数，指定有关聚合的其它选项</li>
</ul>
<h4 id="格式化"><a href="#格式化" class="headerlink" title="格式化"></a>格式化</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find(&lt;query&gt;).pretty()</span><br></pre></td></tr></table></figure>
<h4 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find(&lt;query&gt;).sort(&#123;&lt;field&gt;: &lt;positive integer&gt;&#125;)</span><br></pre></td></tr></table></figure>
<p>将结果根据field进行排序，并使用 1 和 -1 来指定排序的方式，其中 1 为升序排列，而 -1 是用于降序排列。  </p>
<h4 id="限制返回条数"><a href="#限制返回条数" class="headerlink" title="限制返回条数"></a>限制返回条数</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find(&lt;query&gt;).limit(&lt;positive integer&gt;)</span><br></pre></td></tr></table></figure>
<p>限制返回n条数据</p>
<h4 id="跳过固定条数数据"><a href="#跳过固定条数数据" class="headerlink" title="跳过固定条数数据"></a>跳过固定条数数据</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find(&lt;query&gt;).skip(&lt;positive integer&gt;)</span><br></pre></td></tr></table></figure>
<p>跳过固定n条数数据</p>
<h4 id="查看执行计划"><a href="#查看执行计划" class="headerlink" title="查看执行计划"></a>查看执行计划</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.COLLECTION_NAME.find(&lt;query&gt;).explain()</span><br><span class="line">db.COLLECTION_NAME.find( &#123; $query: &#123;&#125;, $explain: 1 &#125; )</span><br><span class="line">db.COLLECTION_NAME.explain().find(&lt;query&gt;)</span><br></pre></td></tr></table></figure>
<h3 id="MongoDB-操作符"><a href="#MongoDB-操作符" class="headerlink" title="MongoDB 操作符"></a>MongoDB 操作符</h3><p>MongoDB 操作符分为</p>
<ul>
<li>查询与预测操作符</li>
<li>更新操作符</li>
<li>聚合管道步骤</li>
<li>聚合管道操作符</li>
<li>查询修饰符</li>
</ul>
<p>以下列举常用的一些操作符</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>类型</th>
<th>描述</th>
<th>语法</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>$eq</code></td>
<td>比较</td>
<td>equal 值相等</td>
<td><code>&#123; &lt;field&gt;: &#123; $eq: &lt;value&gt; &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$gt</code></td>
<td>比较</td>
<td>greater than 值大于</td>
<td><code>&#123; &lt;field&gt;: &#123;$gt: &lt;value&gt;&#125; &#125;</code></td>
</tr>
<tr>
<td><code>$gte</code></td>
<td>比较</td>
<td>greater than equal 值大于等于</td>
<td><code>&#123; &lt;field&gt;: &#123;$gte: &lt;value&gt;&#125; &#125;</code></td>
</tr>
<tr>
<td><code>$in</code></td>
<td>比较</td>
<td>值存在于</td>
<td><code>&#123; &lt;field&gt;: &#123; $in: [&lt;value1&gt;, &lt;value2&gt;, ... &lt;valueN&gt; ] &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$lt</code></td>
<td>比较</td>
<td>less than 值小于</td>
<td><code>&#123; &lt;field&gt;: &#123;$lt: &lt;value&gt;&#125; &#125;</code></td>
</tr>
<tr>
<td><code>$lte</code></td>
<td>比较</td>
<td>less than equal 值小于等于</td>
<td><code>&#123; &lt;field&gt;: &#123; $lte: &lt;value&gt;&#125; &#125;</code></td>
</tr>
<tr>
<td><code>$ne</code></td>
<td>比较</td>
<td>not equal 值不等于</td>
<td><code>&#123; &lt;field&gt;: &#123;$ne: &lt;value&gt;&#125; &#125;</code></td>
</tr>
<tr>
<td><code>$nin</code></td>
<td>比较</td>
<td>not in 值不存在于</td>
<td><code>&#123; &lt;field&gt;: &#123; $nin: [ &lt;value1&gt;, &lt;value2&gt; ... &lt;valueN&gt; ]&#125; &#125;</code></td>
</tr>
<tr>
<td><code>$and</code></td>
<td>逻辑</td>
<td>与，跟表达式数组，表达式之间是与关系</td>
<td><code>&#123; $and: [ &#123; &lt;expression1&gt; &#125;, &#123; &lt;expression2&gt; &#125; , ... , &#123; &lt;expressionN&gt; &#125; ] &#125;</code></td>
</tr>
<tr>
<td><code>$not</code></td>
<td>逻辑</td>
<td>非，跟操作符表达式</td>
<td><code>&#123; &lt;field&gt;: &#123; $not: &#123; &lt;operator-expression&gt; &#125; &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$nor</code></td>
<td>逻辑</td>
<td>异或，跟表达式数组，表达式之间是异或关系</td>
<td>{ <code>$nor: [ &#123; &lt;expression1&gt; &#125;, &#123; &lt;expression2&gt; &#125;, ...  &#123; &lt;expressionN&gt; &#125; ] &#125;</code></td>
</tr>
<tr>
<td><code>$or</code></td>
<td>逻辑</td>
<td>或，跟表达式数组，表达式之间是或关系</td>
<td><code>&#123; $or: [ &#123; &lt;expression1&gt; &#125;, &#123; &lt;expression2&gt; &#125;, ... , &#123; &lt;expressionN&gt; &#125; ] &#125;</code></td>
</tr>
<tr>
<td><code>$exists</code></td>
<td>元素</td>
<td>表示field是否存在</td>
<td><code>&#123; &lt;field&gt;: &#123; $exists: &lt;boolean&gt; &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$type</code></td>
<td>元素</td>
<td>表示field需要符合列出的BSON类型，<code>&lt;BSON type&gt;</code>可以是 <a href="#BSON-Types">BSON Types</a> 的别名或者数字</td>
<td><code>&#123; &lt;field&gt;: &#123; $type: &lt;BSON type&gt; &#125; &#125;</code> <br> <code>&#123; &lt;field&gt;: &#123; $type: [ &lt;BSON type1&gt; , &lt;BSON type2&gt;, ... ] &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$where</code></td>
<td>评估</td>
<td><code>$where</code> 查询操作符只对最顶层的document生效，会执行javascript但不走索引，所以尽量先使用其它操作符对数据进行过滤</td>
<td><code>&#123;$where: function() &#123;&lt;code&gt; return true;&#125;&#125;</code></td>
</tr>
<tr>
<td><code>$all</code></td>
<td>数组</td>
<td>field应当是数组，过滤出包含所有给定数组中值的field</td>
<td><code>&#123; &lt;field&gt;: &#123; $all: [ &lt;value1&gt; , &lt;value2&gt; ... ] &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$elemMath</code></td>
<td>数组</td>
<td>field应当是数组，过滤出至少有一个元素符合所有给定表达式的field</td>
<td><code>&#123; &lt;field&gt;: &#123; $elemMatch: &#123; &lt;query1&gt;, &lt;query2&gt;, ... &#125; &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$size</code></td>
<td>数组</td>
<td>field应当是数组，过滤出所有元素数量符合size的field</td>
<td><code>&#123; &lt;field&gt;: &#123; $size: &lt;positive integer&gt; &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$comment</code></td>
<td>评论</td>
<td>为查询添加注释</td>
<td><code>&#123; &lt;query&gt;, $comment: &lt;comment&gt; &#125;</code></td>
</tr>
<tr>
<td><code>$sort</code></td>
<td>聚合</td>
<td>排序，根据给定的field和排序规则对结果进行排序，<code>&lt;sort order&gt;</code>有两种取值，1代表asc，-1代表desc</td>
<td><code>&#123; $sort: &#123; &lt;field1&gt;: &lt;sort order&gt;, &lt;field2&gt;: &lt;sort order&gt; ... &#125; &#125;</code></td>
</tr>
<tr>
<td><code>$limit</code></td>
<td>聚合</td>
<td>限制取前n个数据</td>
<td><code>&#123; $limit: &lt;positive integer&gt; &#125;</code></td>
</tr>
<tr>
<td><code>$skip</code></td>
<td>聚合</td>
<td>跳过n个数据</td>
<td><code>&#123; $skip: &lt;positive integer&gt; &#125;</code></td>
</tr>
<tr>
<td><code>$group</code></td>
<td>聚合</td>
<td>分组，通过特定表达式与输出将文档分成不同的group</td>
<td><code>&#123; $group: &#123; _id: &lt;expression&gt;, &lt;field1&gt;: &#123; &lt;accumulator1&gt; : &lt;expression1&gt; &#125;, ... &#125; &#125;</code></td>
</tr>
</tbody>
</table>
<h2 id="事务与原子性"><a href="#事务与原子性" class="headerlink" title="事务与原子性"></a>事务与原子性</h2><p>MongoDB在 4.0版本之后支持了多文档事务，并且计划在4.2版本支持分布式事务。  </p>
<p>在MongoDB中，对单文件的操作是原子性的。4.0之后通过复制集合的方式支持了多文档事务。多文档事务支持跨多操作、集合、数据库以及文档，但是大部分情况下相比于单文档写会导致巨大的性能消耗。官方仍旧推荐嵌入式的文档模型而不是多文档事务。而且多文档事务限制较多，具体限制可以查看 <a target="_blank" rel="noopener" href="https://docs.mongodb.com/manual/core/transactions/">事务文档</a> 。  </p>
<p>只有存储引擎 WiredTiger 支持 多文档事务，内存数据引擎或 MMAPv1 存储引擎不支持。  </p>
<p>事务例子如下：  </p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start a session.</span></span><br><span class="line">session = db.<span class="title function_">getMongo</span>().<span class="title function_">startSession</span>( &#123; <span class="attr">readPreference</span>: &#123; <span class="attr">mode</span>: <span class="string">&quot;primary&quot;</span> &#125; &#125; );</span><br><span class="line"></span><br><span class="line">employeesCollection = session.<span class="title function_">getDatabase</span>(<span class="string">&quot;hr&quot;</span>).<span class="property">employees</span>;</span><br><span class="line">eventsCollection = session.<span class="title function_">getDatabase</span>(<span class="string">&quot;reporting&quot;</span>).<span class="property">events</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Start a transaction</span></span><br><span class="line">session.<span class="title function_">startTransaction</span>( &#123; <span class="attr">readConcern</span>: &#123; <span class="attr">level</span>: <span class="string">&quot;snapshot&quot;</span> &#125;, <span class="attr">writeConcern</span>: &#123; <span class="attr">w</span>: <span class="string">&quot;majority&quot;</span> &#125; &#125; );</span><br><span class="line"></span><br><span class="line"><span class="comment">// Operations inside the transaction</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">   employeesCollection.<span class="title function_">updateOne</span>( &#123; <span class="attr">employee</span>: <span class="number">3</span> &#125;, &#123; <span class="attr">$set</span>: &#123; <span class="attr">status</span>: <span class="string">&quot;Inactive&quot;</span> &#125; &#125; );</span><br><span class="line">   eventsCollection.<span class="title function_">insertOne</span>( &#123; <span class="attr">employee</span>: <span class="number">3</span>, <span class="attr">status</span>: &#123; <span class="attr">new</span>: <span class="string">&quot;Inactive&quot;</span>, <span class="attr">old</span>: <span class="string">&quot;Active&quot;</span> &#125; &#125; );</span><br><span class="line">&#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">   <span class="comment">// Abort transaction on error</span></span><br><span class="line">   session.<span class="title function_">abortTransaction</span>();</span><br><span class="line">   <span class="keyword">throw</span> error;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Commit the transaction using write concern set at transaction start</span></span><br><span class="line">session.<span class="title function_">commitTransaction</span>();</span><br><span class="line"></span><br><span class="line">session.<span class="title function_">endSession</span>();</span><br></pre></td></tr></table></figure>

        
    </section>
    
      <footer class="appreciate">
    <p>觉得本文不错？可以赞赏支持我创作！</p>
    <a id="appreciate-btn" href="#appreciate-modal" rel="modal:open" data-options='{"fadeDuration": 250,"fadeDelay": 0.80}'>
        <button type="button" class="appreciate-btn">赞赏支持</button>
    </a>
</footer>
    
</article>




        
            </div>
        
        <article id="search-result" class="search-result content"></article>
        <footer class="footer">
    
        <div class="license">
            <p>版权声明
                <a target="_blank" rel="license noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商用-相同方式共享4.0 (CC BY-NC-SA 4.0)</a>
            </p>
        </div>
    
</footer>


    </main>

    
    <div id="appreciate-modal" class="modal">
    <div class="appreciate-container">
        <div class="appreciate-image">
            <img src="/blog/images/zfb.png" alt="支付宝二维码"></img>
            <p>⬆️支付宝</p>
        </div>
        <div class="appreciate-image">
            <img src="/blog/images/wx.png" alt="微信二维码"></img>
            <p>⬆️微信</p>
        </div>
    </div>
</div>
    
    <script type="text/javascript" src="/blog/js/jquery.min.js"></script>
    <script type="text/javascript" src="/blog/js/jquery.modal.min.js"></script>
    <script type="text/javascript" src="/blog/js/common.js"></script>
    <script type="text/javascript" src="/blog/js/home.js"></script>
    <script type="text/javascript">
        $(function() {
            var nodes = {
                nav: $('#nav'),
                aside: $('#aside'),
                navTags: $('#nav-tags')
            };

            $('#open-panel, #aside-mask').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('.toc-link').on('click', function() {
                nodes.aside.toggleClass('panel-show');
            });
            $('#nav-tag').on('click', function(event) {
                event.preventDefault();
                // console.log(nodes.navTags.attr('class'))
                nodes.navTags.toggleClass('tag-show');
                // console.log(nodes.navTags.attr('class'))
            });/*.hover(function() {
                nodes.navTags.addClass('tag-show');
            }, function() {
                nodes.navTags.removeClass('tag-show');
            });*/
        });
    </script>
    
        <script type="text/javascript" src="/blog/js/search.js"></script>
        <script type="text/javascript">
            var search_path = "search.xml";
            if (search_path.length == 0) {
                search_path = "search.xml";
            }
            var path = "/blog/" + search_path;
            searchFunc(path, 'search-box', 'search-result');
        </script>
    
    
        <script type="text/javascript" src="/blog/js/scrollspy.min.js"></script>
        <script type="text/javascript">
        $('#content').scrollspy({target: '#aside-inner'});
        document.querySelector(decodeURIComponent(document.location.hash) || '#content')?.scrollIntoView();
        </script>
    
    
        <script>
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?bd8c20273d10c04abf64252ca5fdf77b";
            var s = document.getElementsByTagName("script")[0]; 
            s.parentNode.insertBefore(hm, s);
        })();
        </script>
    
</body>
</html>
